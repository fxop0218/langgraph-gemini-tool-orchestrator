<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <title>Chat de Sesión · Generador de Archivos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Markdown (parser + sanitizer) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
    <style>
        :root {
            --bg: #07140d;
            --panel: #0e2217;
            --ink: #e9fff1;
            --muted: #a7d3b8;
            --accent: #25c26e;
            --accent-2: #1a9b56;
            --chip: #10311f;
            --border: #174c31;
            --bubble: #0b1c13;
            --bubble-user: #10311f;
            --tool: #0f281b;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: var(--ink);
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
        }

        a {
            color: var(--accent);
            text-decoration: none
        }

        .wrap {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
            min-height: 100%;
            padding: 16px
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 12px 40px rgba(0, 0, 0, .25)
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px
        }

        .header h2 {
            margin: 0;
            font-size: 18px
        }

        .muted {
            color: var(--muted);
            font-size: 12px
        }

        .row {
            display: flex;
            gap: 8px;
            align-items: center
        }

        .btn {
            background: var(--accent);
            border: 1px solid var(--accent-2);
            color: #082312;
            padding: 10px 14px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer
        }

        .btn.secondary {
            background: transparent;
            color: var(--ink);
            border: 1px solid var(--border)
        }

        .btn.ghost {
            background: transparent;
            color: var(--accent);
            border: 1px solid var(--accent)
        }

        .btn:disabled {
            opacity: .6;
            cursor: not-allowed
        }

        .session-chip {
            background: var(--chip);
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            color: var(--muted);
            border: 1px solid var(--border)
        }

        .chat-log {
            flex: 1;
            overflow: auto;
            padding: 10px;
            border-radius: 12px;
            background: var(--bubble);
            border: 1px solid var(--border)
        }

        .msg {
            margin: 10px 0;
            display: grid;
            grid-template-columns: 70px 1fr;
            gap: 8px
        }

        .msg .who {
            color: var(--muted);
            font-size: 12px;
            text-align: right;
            padding-top: 3px
        }

        .msg .bubble {
            background: #0c2117;
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid var(--border)
        }

        .msg.user .bubble {
            background: var(--bubble-user);
            white-space: pre-wrap
        }

        .msg.tool .bubble {
            background: var(--tool);
            border-style: dashed
        }

        .input-area {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            margin-top: 12px
        }

        textarea {
            resize: vertical;
            min-height: 56px;
            max-height: 200px;
            background: #0a1a12;
            color: var(--ink);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            outline: none
        }

        textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(37, 194, 110, .15)
        }

        .kbd {
            background: #0f281b;
            padding: 2px 6px;
            border-radius: 6px;
            border: 1px solid var(--border);
            font-family: ui-monospace, Menlo, Consolas, monospace;
            font-size: 12px
        }

        .files {
            flex: 1;
            overflow: auto
        }

        .file {
            background: #0a1a12;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 8px;
            border: 1px solid var(--border)
        }

        .divider {
            height: 1px;
            background: var(--border);
            margin: 8px 0
        }

        .empty {
            color: var(--muted);
            text-align: center;
            margin-top: 24px
        }

        /* Markdown defaults dentro de burbujas */
        .bubble :where(p, ol, ul) {
            margin: 0 0 .6em 0
        }

        .bubble ul {
            padding-left: 1.25em
        }

        .bubble ol {
            padding-left: 1.4em
        }

        .bubble code {
            font-family: ui-monospace, Menlo, Consolas, monospace;
            background: #0a1a12;
            padding: .1em .35em;
            border: 1px solid var(--border);
            border-radius: 6px
        }

        .bubble pre {
            background: #0a1a12;
            border: 1px solid var(--border);
            padding: 10px;
            border-radius: 10px;
            overflow: auto
        }

        ::-webkit-scrollbar {
            height: 10px;
            width: 10px
        }

        ::-webkit-scrollbar-thumb {
            background: #184b30;
            border-radius: 10px
        }

        ::-webkit-scrollbar-track {
            background: #0a1a12
        }

        @media (max-width:980px) {
            .wrap {
                grid-template-columns: 1fr
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <!-- Chat -->
        <div class="card" id="chat-card">
            <div class="header">
                <h2>Chat Operativo</h2>
                <div class="row">
                    <span class="session-chip" id="sessionChip">sesión: —</span>
                    <button class="btn ghost" id="newSessionBtn" title="Crear nueva sesión">Nueva sesión</button>
                </div>
            </div>

            <div class="chat-log" id="chatLog" aria-live="polite"></div>

            <div class="input-area">
                <textarea id="message"
                    placeholder="Escribe tu mensaje… (p. ej., «Lista de productos»). Enter para enviar, Shift+Enter para salto."></textarea>
                <button class="btn" id="sendBtn">Enviar</button>
            </div>
            <div class="muted" style="margin-top:8px">
                Atajos: <span class="kbd">Enter</span> enviar · <span class="kbd">Shift+Enter</span> salto · <span
                    class="kbd">Ctrl+K</span> limpiar chat
            </div>
        </div>

        <!-- Archivos -->
        <div class="card">
            <div class="header">
                <h2>Archivos de la sesión</h2>
                <div class="row">
                    <button class="btn secondary" id="refreshBtn">Refrescar</button>
                    <button class="btn secondary" id="clearFilesBtn">Limpiar lista</button>
                </div>
            </div>
            <div class="files" id="filesList">
                <div class="empty">Aún no hay archivos. Cuando las herramientas creen CSV/XLSX, aparecerán aquí.</div>
            </div>
            <div class="divider"></div>
            <div class="muted">Los ficheros se sirven desde <code>/files</code> del mismo servidor.</div>
        </div>
    </div>

    <script>
        // === Config: mismo origen ===
        const API_BASE = window.location.origin;

        // === Estado ===
        let sessionId = localStorage.getItem("session_id") || null;
        const filesSeen = new Map(); // url -> meta

        // === Helpers ===
        const $ = (sel) => document.querySelector(sel);
        function setSessionChip(id) { $("#sessionChip").textContent = `sesión: ${id}`; }

        async function ensureSession() {
            if (sessionId) { setSessionChip(sessionId); return sessionId; }
            const r = await fetch(`${API_BASE}/sessions/new`, { method: "POST" });
            if (!r.ok) throw new Error("No se pudo crear la sesión");
            const data = await r.json();
            sessionId = data.session_id;
            localStorage.setItem("session_id", sessionId);
            setSessionChip(sessionId);
            return sessionId;
        }

        function renderMarkdown(md) {
            // Config mínima para marked (puedes ajustar si quieres tablas, breaks, etc.)
            marked.setOptions({ breaks: true, mangle: false, headerIds: false });
            const html = marked.parse(md || "");
            return DOMPurify.sanitize(html);
        }

        function renderMessage(role, content) {
            const log = $("#chatLog");
            const wrap = document.createElement("div");
            wrap.className = `msg ${role}`;
            const who = document.createElement("div");
            who.className = "who";
            who.textContent = role === "user" ? "Tú" : (role === "tool" ? "Tool" : "Bot");
            const bubble = document.createElement("div");
            bubble.className = "bubble";

            if (role === "user") {
                // usuario → texto plano
                bubble.textContent = typeof content === "string" ? content : JSON.stringify(content, null, 2);
            } else {
                // bot/tool → Markdown sanitzado
                const md = typeof content === "string" ? content : "```json\n" + JSON.stringify(content, null, 2) + "\n```";
                bubble.innerHTML = renderMarkdown(md);
            }

            wrap.appendChild(who); wrap.appendChild(bubble);
            log.appendChild(wrap);
            log.scrollTop = log.scrollHeight;
        }

        function normalizePathToUrl(absOrOsPath) {
            if (!absOrOsPath) return null;
            let p = String(absOrOsPath).replace(/\\/g, "/");
            const idx = p.toLowerCase().lastIndexOf("/files/");
            if (idx === -1) return null;
            const rel = p.substring(idx);
            return `${API_BASE}${rel}`;
        }

        function upsertFile(url, meta = {}) {
            if (!url) return;
            if (!filesSeen.has(url)) { filesSeen.set(url, meta); renderFiles(); }
        }

        function renderFiles() {
            const list = $("#filesList"); list.innerHTML = "";
            if (!filesSeen.size) {
                const empty = document.createElement("div");
                empty.className = "empty";
                empty.textContent = "Aún no hay archivos. Cuando las herramientas creen CSV/XLSX, aparecerán aquí.";
                list.appendChild(empty); return;
            }
            for (const [url, meta] of filesSeen.entries()) {
                const item = document.createElement("div"); item.className = "file";
                const a = document.createElement("a"); a.href = url; a.download = ""; a.target = "_blank"; a.textContent = url;
                item.appendChild(a);
                const info = [];
                if (meta.order_by) info.push(`orden: ${meta.order_by}`);
                if (meta.file_format) info.push(`formato: ${meta.file_format}`);
                if (info.length) {
                    const small = document.createElement("div");
                    small.className = "muted"; small.textContent = `(${info.join(" · ")})`;
                    item.appendChild(small);
                }
                list.appendChild(item);
            }
        }

        async function sendMessage() {
            const ta = $("#message"); const txt = ta.value.trim(); if (!txt) return;
            ta.value = ""; renderMessage("user", txt); $("#sendBtn").disabled = true;

            try {
                await ensureSession();
                const r = await fetch(`${API_BASE}/chat`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: txt, session_id: sessionId }),
                });
                if (!r.ok) {
                    const err = await r.text();
                    renderMessage("bot", `**Error ${r.status}:** ${err}`); return;
                }
                const data = await r.json();
                renderMessage("bot", data.reply || "(empty)");

                if (Array.isArray(data.tool_events)) {
                    for (const ev of data.tool_events) {
                        const pretty = typeof ev.content === "string" ? ev.content : "```json\n" + JSON.stringify(ev.content, null, 2) + "\n```";
                        renderMessage("tool", `**${ev.name}**\n\n${pretty}`);
                        const c = ev.content;
                        try {
                            if (c && typeof c === "object") {
                                if (c.path) {
                                    const url = normalizePathToUrl(c.path);
                                    if (url) upsertFile(url, { order_by: c.order_by, file_format: c.file_format });
                                }
                                if (Array.isArray(c.paths)) {
                                    for (const p of c.paths) {
                                        const url = normalizePathToUrl(p);
                                        if (url) upsertFile(url, {});
                                    }
                                }
                            } else if (typeof c === "string") {
                                const match = c.replace(/\\/g, "/").match(/\/files\/[^\s'"]+/i);
                                if (match) { upsertFile(`${API_BASE}${match[0]}`, {}); }
                            }
                        } catch (e) { console.warn("No se pudo procesar tool_event:", e); }
                    }
                }
            } catch (e) {
                console.error("Fetch error:", e);
                renderMessage("bot", `**Excepción de red:** ${e?.message || e}. Verifica que la API esté en \`${API_BASE}\`.`);
            } finally {
                $("#sendBtn").disabled = false; $("#message").focus();
            }
        }

        (async function init() {
            await ensureSession();
            renderMessage("bot", "Sesión inicializada. ¿En qué puedo ayudar?");
        })();

        $("#sendBtn").addEventListener("click", sendMessage);
        $("#message").addEventListener("keydown", (ev) => {
            if (ev.key === "Enter" && !ev.shiftKey) { ev.preventDefault(); sendMessage(); }
            if (ev.ctrlKey && ev.key.toLowerCase() === "k") { $("#chatLog").innerHTML = ""; }
        });
        $("#newSessionBtn").addEventListener("click", async () => {
            localStorage.removeItem("session_id"); sessionId = null; filesSeen.clear(); renderFiles();
            await ensureSession(); renderMessage("bot", "Nueva sesión creada.");
        });
        $("#clearFilesBtn").addEventListener("click", () => { filesSeen.clear(); renderFiles(); });
        $("#refreshBtn").addEventListener("click", () => { renderFiles(); });
    </script>
</body>

</html>